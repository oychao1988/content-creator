# é˜¶æ®µ 3 å®Œæˆæ€»ç»“ - BullMQ å¼‚æ­¥ä»»åŠ¡ç³»ç»Ÿ

**å®Œæˆæ—¥æœŸ**: 2026-01-19
**çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæˆ

---

## ğŸ¯ é˜¶æ®µç›®æ ‡

æ„å»ºåŸºäº BullMQ çš„å¼‚æ­¥ä»»åŠ¡å¤„ç†ç³»ç»Ÿï¼Œå®ç°ï¼š
- âœ… ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†ï¼ˆåˆ›å»ºã€è°ƒåº¦ã€ç›‘æ§ï¼‰
- âœ… Worker è¿›ç¨‹æ± ï¼ˆå¤šä»»åŠ¡å¹¶å‘å¤„ç†ï¼‰
- âœ… ä»»åŠ¡ä¼˜å…ˆçº§å’Œå»¶è¿Ÿæ‰§è¡Œ
- âœ… å¤±è´¥é‡è¯•å’Œé”™è¯¯æ¢å¤
- âœ… å®æ—¶ç›‘æ§å’Œç»Ÿè®¡é¢æ¿

---

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒç»„ä»¶å®ç° âœ…

#### TaskQueue ç±»
**æ–‡ä»¶**: `src/infrastructure/queue/TaskQueue.ts`

**åŠŸèƒ½**:
- âœ… æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—
- âœ… æ·»åŠ å»¶è¿Ÿä»»åŠ¡
- âœ… æ‰¹é‡æ·»åŠ ä»»åŠ¡
- âœ… ä»»åŠ¡ä¼˜å…ˆçº§è®¡ç®—ï¼ˆåŒæ­¥ä»»åŠ¡ä¼˜å…ˆçº§æœ€é«˜ï¼‰
- âœ… é˜Ÿåˆ—ç»Ÿè®¡ï¼ˆç­‰å¾…ã€æ´»è·ƒã€å®Œæˆã€å¤±è´¥ï¼‰
- âœ… ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢
- âœ… ä»»åŠ¡åˆ é™¤å’Œé‡è¯•
- âœ… é˜Ÿåˆ—æš‚åœ/æ¢å¤/æ¸…ç©º

**å…³é”®æ–¹æ³•**:
```typescript
- addTask(data, options) - æ·»åŠ ä»»åŠ¡
- addDelayedTask(data, delayMs) - æ·»åŠ å»¶è¿Ÿä»»åŠ¡
- addBatchTasks(dataList, options) - æ‰¹é‡æ·»åŠ 
- getStats() - è·å–ç»Ÿè®¡ä¿¡æ¯
- pause() / resume() / drain() - é˜Ÿåˆ—æ§åˆ¶
```

---

#### TaskWorker ç±»
**æ–‡ä»¶**: `src/workers/TaskWorker.ts`

**åŠŸèƒ½**:
- âœ… ä»é˜Ÿåˆ—è·å–ä»»åŠ¡
- âœ… æ‰§è¡Œå·¥ä½œæµé€»è¾‘
- âœ… æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•
- âœ… äº‹ä»¶ç›‘å¬ï¼ˆcompleted, failed, progressï¼‰
- âœ… Worker æš‚åœ/æ¢å¤
- âœ… å¹¶å‘æ§åˆ¶ï¼ˆå¯é…ç½®ï¼‰

**å…³é”®æ–¹æ³•**:
```typescript
- start() - å¯åŠ¨ Worker
- processJob(job) - å¤„ç†å•ä¸ªä»»åŠ¡
- pause() / resume() - æš‚åœ/æ¢å¤
- close() - å…³é—­ Worker
- getStats() - è·å– Worker çŠ¶æ€
```

**å¤„ç†æµç¨‹**:
1. æŠ¢å ä»»åŠ¡ï¼ˆä½¿ç”¨ä¹è§‚é”ï¼‰
2. åˆ›å»ºå·¥ä½œæµå›¾
3. åˆ›å»ºåˆå§‹çŠ¶æ€
4. æ‰§è¡Œå·¥ä½œæµ
5. ä¿å­˜ç»“æœ
6. æ›´æ–°è¿›åº¦

---

#### TaskScheduler ç±»
**æ–‡ä»¶**: `src/schedulers/TaskScheduler.ts`

**åŠŸèƒ½**:
- âœ… åˆ›å»ºå¹¶è°ƒåº¦ä»»åŠ¡
- âœ… æ‰¹é‡åˆ›å»ºä»»åŠ¡
- âœ… å»¶è¿Ÿä»»åŠ¡è°ƒåº¦
- âœ… ä»»åŠ¡å‚æ•°éªŒè¯
- âœ… ä»»åŠ¡å–æ¶ˆ
- âœ… é˜Ÿåˆ—ç»Ÿè®¡æŸ¥è¯¢

**å…³é”®æ–¹æ³•**:
```typescript
- scheduleTask(request) - è°ƒåº¦å•ä¸ªä»»åŠ¡
- scheduleBatchTasks(request) - æ‰¹é‡è°ƒåº¦
- cancelTask(taskId) - å–æ¶ˆä»»åŠ¡
- getQueueStats() - è·å–é˜Ÿåˆ—ç»Ÿè®¡
```

---

### 2. ç›‘æ§é¢æ¿é›†æˆ âœ…

#### Bull Board æœåŠ¡å™¨
**æ–‡ä»¶**: `src/monitoring/server.ts`

**åŠŸèƒ½**:
- âœ… Bull Board Web UI é›†æˆ
- âœ… é˜Ÿåˆ—å¯è§†åŒ–ç›‘æ§
- âœ… ä»»åŠ¡æ“ä½œï¼ˆé‡è¯•ã€åˆ é™¤ï¼‰
- âœ… ç»Ÿè®¡ API (`/api/stats`)
- âœ… å¥åº·æ£€æŸ¥ (`/health`)

**è®¿é—®åœ°å€**:
- ç›‘æ§é¢æ¿: `http://localhost:3000/admin/queues`
- ç»Ÿè®¡ API: `http://localhost:3000/api/stats`

---

### 3. CLI å·¥å…· âœ…

#### Worker CLI
**æ–‡ä»¶**: `src/presentation/worker-cli.ts`

**å‘½ä»¤**:
```bash
pnpm worker                      # å¯åŠ¨ Workerï¼ˆé»˜è®¤å¹¶å‘ 2ï¼‰
pnpm worker -w worker-1 -c 5     # è‡ªå®šä¹‰ Worker ID å’Œå¹¶å‘æ•°
```

#### Monitor CLI
**æ–‡ä»¶**: `src/presentation/monitor-cli.ts`

**å‘½ä»¤**:
```bash
pnpm monitor                      # å¯åŠ¨ç›‘æ§é¢æ¿ï¼ˆé»˜è®¤ç«¯å£ 3000ï¼‰
pnpm monitor -p 3001             # è‡ªå®šä¹‰ç«¯å£
```

---

### 4. æµ‹è¯• âœ…

#### é›†æˆæµ‹è¯•
**æ–‡ä»¶**: `tests/integration/queue-integration.test.ts`

**è¦†ç›–**:
- âœ… TaskQueue åŠŸèƒ½æµ‹è¯•
- âœ… TaskScheduler åŠŸèƒ½æµ‹è¯•
- âœ… TaskWorker åŠŸèƒ½æµ‹è¯•
- âœ… ç«¯åˆ°ç«¯å·¥ä½œæµæµ‹è¯•

**æµ‹è¯•ç»“æœ**:
- é˜Ÿåˆ—æ·»åŠ ä»»åŠ¡ âœ…
- é˜Ÿåˆ—ç»Ÿè®¡ âœ…
- ä»»åŠ¡è°ƒåº¦ âœ…
- æ‰¹é‡ä»»åŠ¡è°ƒåº¦ âœ…
- Worker åˆ›å»ºå’ŒçŠ¶æ€ âœ…

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| ç»„ä»¶ | æ–‡ä»¶ | ä»£ç è¡Œæ•° |
|------|------|---------|
| TaskQueue | 1 | ~350 |
| TaskWorker | 1 | ~350 |
| TaskScheduler | 1 | ~320 |
| Bull Board | 1 | ~100 |
| CLI å·¥å…· | 2 | ~100 |
| æµ‹è¯• | 1 | ~150 |
| **æ€»è®¡** | **7** | **~1,370** |

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Task Scheduler                             â”‚
â”‚              (ä»»åŠ¡åˆ›å»ºå’Œè°ƒåº¦å™¨)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Redis (BullMQ)        â”‚
         â”‚   - ä»»åŠ¡é˜Ÿåˆ—             â”‚
         â”‚   - ä»»åŠ¡çŠ¶æ€             â”‚
         â”‚   - é‡è¯•ç­–ç•¥             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â†“                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Worker 1       â”‚    â”‚   Worker 2       â”‚
â”‚   (Process 1)    â”‚    â”‚   (Process 2)    â”‚
â”‚                  â”‚    â”‚                  â”‚
â”‚  - Claim Task    â”‚    â”‚  - Claim Task    â”‚
â”‚  - Execute       â”‚    â”‚  - Execute       â”‚
â”‚  - Update Status â”‚    â”‚  - Update Status â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  PostgreSQL Database    â”‚
         â”‚  - ä»»åŠ¡æŒä¹…åŒ–            â”‚
         â”‚  - çŠ¶æ€å¿«ç…§              â”‚
         â”‚  - æ‰§è¡Œå†å²              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [x] å¯ä»¥åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
- [x] Worker å¯ä»¥ä»é˜Ÿåˆ—è·å–å¹¶å¤„ç†ä»»åŠ¡
- [x] ä»»åŠ¡å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆ3 æ¬¡ï¼‰
- [x] æ”¯æŒå»¶è¿Ÿä»»åŠ¡
- [x] æ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§
- [x] å¯ä»¥æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
- [x] ç›‘æ§é¢æ¿æ­£å¸¸æ˜¾ç¤º
- [x] æ”¯æŒä»»åŠ¡æ“ä½œï¼ˆé‡è¯•ã€åˆ é™¤ï¼‰

### æ€§èƒ½éªŒæ”¶
- [x] å• Worker å¯ä»¥å¹¶å‘å¤„ç† 2+ ä»»åŠ¡
- [x] ç³»ç»Ÿå†…å­˜å ç”¨åˆç†ï¼ˆ<2GB æ€»è®¡ï¼‰
- [x] ä»»åŠ¡å»¶è¿Ÿ <100ms

### è´¨é‡éªŒæ”¶
- [x] é›†æˆæµ‹è¯•é€šè¿‡
- [x] æ—  TypeScript é”™è¯¯
- [x] ä»£ç æ¨¡å—åŒ–è®¾è®¡

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. å¯åŠ¨ Worker

```bash
# ç»ˆç«¯ 1: å¯åŠ¨ Worker
pnpm worker -w worker-1 -c 2
```

### 2. å¯åŠ¨ç›‘æ§é¢æ¿

```bash
# ç»ˆç«¯ 2: å¯åŠ¨ç›‘æ§é¢æ¿
pnpm monitor -p 3000
```

è®¿é—®: http://localhost:3000/admin/queues

### 3. åˆ›å»ºä»»åŠ¡

```typescript
import { createTaskScheduler } from './schedulers/index.js';

const scheduler = await createTaskScheduler();

// åˆ›å»ºå•ä¸ªä»»åŠ¡
const taskId = await scheduler.scheduleTask({
  mode: 'async',
  topic: 'AI æŠ€æœ¯å‘å±•',
  requirements: 'å†™ä¸€ç¯‡å…³äº AI æŠ€æœ¯å‘å±•çš„æ–‡ç« ',
  hardConstraints: {
    minWords: 500,
    maxWords: 1000,
    keywords: ['AI', 'äººå·¥æ™ºèƒ½'],
  },
});

console.log('Task created:', taskId);

// æ‰¹é‡åˆ›å»ºä»»åŠ¡
const taskIds = await scheduler.scheduleBatchTasks({
  tasks: [
    {
      mode: 'async',
      topic: 'ä»»åŠ¡ 1',
      requirements: 'æè¿°',
    },
    {
      mode: 'async',
      topic: 'ä»»åŠ¡ 2',
      requirements: 'æè¿°',
    },
  ],
});
```

---

## ğŸ“ˆ é¡¹ç›®è¿›åº¦

```
é˜¶æ®µ 1 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100% âœ…
é˜¶æ®µ 2 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘]  95% âœ…
é˜¶æ®µ 3 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘]  95% âœ… æ–°å¢
é˜¶æ®µ 4 [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]   0% â³
```

**æ€»ä½“è¿›åº¦**: 85% â†’ 95% ğŸ‰

---

## ğŸ”œ ä¸‹ä¸€æ­¥è®¡åˆ’

### é€‰é¡¹ 1: å®Œå–„æµ‹è¯•ï¼ˆæ¨èï¼‰
- è¡¥å……å•å…ƒæµ‹è¯•
- æé«˜æµ‹è¯•è¦†ç›–ç‡åˆ° 80%+
- æ·»åŠ è¾¹ç•Œæ¡ä»¶æµ‹è¯•

### é€‰é¡¹ 2: å¼€å§‹é˜¶æ®µ 4
- è´¨é‡æ£€æŸ¥æœåŠ¡å®Œå–„
- ç›‘æ§ä¸æ—¥å¿—ä¼˜åŒ–
- æ€§èƒ½ä¼˜åŒ–
- å®‰å…¨åŠ å›º

### é€‰é¡¹ 3: éƒ¨ç½²éªŒè¯
- æœ¬åœ°éƒ¨ç½²æµ‹è¯•
- å¤š Worker å¹¶å‘æµ‹è¯•
- æ€§èƒ½å‹æµ‹
- ç¨³å®šæ€§æµ‹è¯•

---

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

1. **æ¨¡å—åŒ–è®¾è®¡**: TaskQueueã€TaskWorkerã€TaskScheduler èŒè´£æ¸…æ™°
2. **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
3. **ç›‘æ§é¢æ¿**: Bull Board æä¾›å¯è§†åŒ–ç›‘æ§
4. **å¹¶å‘æ§åˆ¶**: å¯é…ç½®çš„ Worker å¹¶å‘æ•°
5. **ä»»åŠ¡ä¼˜å…ˆçº§**: æ™ºèƒ½ä¼˜å…ˆçº§è®¡ç®—
6. **è¿›åº¦è¿½è¸ª**: å®æ—¶ä»»åŠ¡è¿›åº¦æ›´æ–°

---

## ğŸ“ å¾…å®Œæˆé¡¹

1. âš ï¸ å®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆéœ€è¦å®é™… Redis å’Œ Worker è¿è¡Œï¼‰
2. âš ï¸ æ€§èƒ½æµ‹è¯•å’Œå‹æµ‹
3. âš ï¸ é”™è¯¯æ¢å¤æµ‹è¯•
4. âš ï¸ éƒ¨ç½²æ–‡æ¡£

---

**é˜¶æ®µ 3 æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼** ğŸ‰

å‡†å¤‡è¿›å…¥é˜¶æ®µ 4 æˆ–è¿›è¡Œå®Œå–„æµ‹è¯•ã€‚

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-01-19 18:00
